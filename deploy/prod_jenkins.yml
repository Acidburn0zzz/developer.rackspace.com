---
- name: Provision Jenkins setup
  hosts: jenkins
  connection: local
  tasks:

    - name: Provision jenkins master server
      local_action:
        module: rax
        credentials: ~/.rackspace_cloud_credentials
        name: jenkins_master_%01d
        flavor: performance1-4
        image: ubuntu-1204-lts-precise-pangolin
        networks:
          - public
          - private
        region: "{{ lookup('env', 'RAX_REGION') | upper }}"
        state: present
        count: 1
        exact_count: yes
        group: jenkins_masters
        wait: yes
        key_name: drg
      register: rax

    - name: Add master server to jenkins_masters host group
      local_action:
        module: add_host
        hostname: "{{ item.name }}"
        ansible_ssh_host: "{{ item.rax_accessipv4 }}"
        groupname: jenkins_masters
      with_items: rax.success
      when: rax.action == 'create'

    - name: Provision 2 jenkins slave servers
      local_action:
        module: rax
        credentials: ~/.rackspace_cloud_credentials
        name: jenkins_slave_%01d
        flavor: performance1-2
        image: ubuntu-1204-lts-precise-pangolin
        networks:
          - private
        region: "{{ lookup('env', 'RAX_REGION') | upper }}"
        state: present
        count: 2
        exact_count: yes
        group: jenkins_slaves
        wait: yes
        key_name: drg

- name: Configure jenkins master server(s)
  hosts: jenkins_masters
  sudo: yes
  vars:
  - plugins:
    - 'github'
  - startup_delay_s: 20
  roles:
    - ICTO.ansible-jenkins

- name: Configure jenkins slave server(s)
  hosts: jenkins_slaves
  sudo: yes