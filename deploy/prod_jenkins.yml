#
# TODO:
# - Configure master to talk to slaves (on private network)
#
---
- name: Provision Jenkins setup
  hosts: jenkins
  connection: local
  gather_facts: False
  tasks:

    - name: Provision jenkins master server
      rax:
        credentials: ~/.rackspace_cloud_credentials
        name: jenkins_master_%01d
        flavor: performance1-4
        image: ubuntu-1204-lts-precise-pangolin
        networks:
          - public
          - private
        region: "{{ lookup('env', 'RAX_REGION') | upper }}"
        state: present
        count: 1
        exact_count: yes
        group: jenkins_masters
        wait: yes
        key_name: drg
      register: rax

    - name: Add master server to jenkins_masters host group
      add_host:
        hostname: "{{ item.name }}"
        ansible_ssh_host: "{{ item.rax_accessipv4 }}"
        groupname: jenkins_masters
      with_items: rax.success
      when: rax.action == 'create'

# We do this so the 'Build Site' Jenkins job can be configured to
# publish content to the right web server hosts in the same region.
- name: Gather info about developer.rackspace.com web servers in same region
  hosts: webservers
  gather_facts: True

- name: Configure jenkins master server(s)
  hosts: jenkins_masters
  sudo: yes
  vars:
  - plugins:
    - 'github'
  - startup_delay_s: 30
  roles:
    - ICTO.ansible-jenkins
    - jenkins_masters
    - jekyll
