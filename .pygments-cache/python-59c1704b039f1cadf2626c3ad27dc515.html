<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">libcloud.security</span>
<span class="kn">import</span> <span class="nn">libcloud.compute.providers</span>
<span class="kn">import</span> <span class="nn">libcloud.compute.types</span>
<span class="kn">from</span> <span class="nn">libcloud.compute.deployment</span> <span class="kn">import</span> <span class="n">MultiStepDeployment</span><span class="p">,</span> <span class="n">ScriptDeployment</span><span class="p">,</span> <span class="n">SSHKeyDeployment</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="c"># Import username and API key from a separate JSON file</span>
<span class="n">creds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;creds.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c"># Don&#39;t verify the SSL cert. USE AT YOUR OWN RISK</span>
<span class="n">libcloud</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">VERIFY_SSL_CERT</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># Create a connection to the Chicago Rackspace endpoint</span>
<span class="n">RackspaceProvider</span> <span class="o">=</span> <span class="n">libcloud</span><span class="o">.</span><span class="n">compute</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">get_driver</span><span class="p">(</span><span class="n">libcloud</span><span class="o">.</span><span class="n">compute</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">Provider</span><span class="o">.</span><span class="n">RACKSPACE_NOVA_ORD</span><span class="p">)</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">RackspaceProvider</span><span class="p">(</span><span class="n">creds</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">],</span> <span class="n">creds</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">],</span>
    <span class="n">ex_force_auth_url</span><span class="o">=</span><span class="s">&#39;https://identity.api.rackspacecloud.com/v2.0/&#39;</span><span class="p">,</span>
    <span class="n">ex_force_auth_version</span><span class="o">=</span><span class="s">&#39;2.0&#39;</span><span class="p">)</span>

<span class="n">images</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">list_images</span><span class="p">()</span> <span class="c"># Get a list of images</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">list_sizes</span><span class="p">()</span> <span class="c"># Get a list of server sizes</span>
<span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sizes</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">ram</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># We want a 1GB server</span>
<span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Ubuntu 12.04 LTS (Precise Pangolin)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># We want Ubuntu 12.04</span>

<span class="c"># Push our SSH key to /root/.ssh/authorized_keys</span>
<span class="n">install_key</span> <span class="o">=</span> <span class="n">SSHKeyDeployment</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;~/.ssh/id_rsa.pub&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c"># Run the puppet install script</span>
<span class="n">install_puppet</span> <span class="o">=</span> <span class="n">ScriptDeployment</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;deploy-puppet.sh&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c"># Multiple-step deployment that installs our SSH key and Puppet</span>
<span class="n">multideploy</span> <span class="o">=</span> <span class="n">MultiStepDeployment</span><span class="p">([</span><span class="n">install_key</span><span class="p">,</span> <span class="n">install_puppet</span><span class="p">])</span>

<span class="c"># Creates our new server, runs deployment steps.</span>
<span class="n">node</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">deploy_node</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;puppet02&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">deploy</span><span class="o">=</span><span class="n">multideploy</span><span class="p">)</span>
</pre></div>