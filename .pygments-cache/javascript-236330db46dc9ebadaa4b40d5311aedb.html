<div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">sendMailGunEmail</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<span class="err"> </span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
<span class="err"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{};</span>
<span class="err"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">apiUrl</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiUrl</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAILGUN_API_URL</span><span class="p">;</span>
<span class="err"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">domain</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAILGUN_DOMAIN</span><span class="p">;</span>
<span class="err"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">apiKey</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiKey</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAILGUN_API_KEY</span><span class="p">;</span>
<span class="err"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">fromAddress</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fromAddress</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAILGUN_FROM_ADDRESS</span><span class="p">;</span>
<span class="err"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">testMode</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">testMode</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAILGUN_TEST_MODE</span><span class="p">;</span>

<span class="err"> </span><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiUrl</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">domain</span> <span class="o">+</span> <span class="s1">&#39;/messages&#39;</span><span class="p">,</span> <span class="nx">bodyObj</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">httpOptions</span><span class="p">;</span>

<span class="err"> </span><span class="nx">httpOptions</span> <span class="o">=</span> <span class="p">{</span><span class="err">                    </span><span class="c1">// 1)  set up some defaults</span>
<span class="err">   </span><span class="s1">&#39;expected_status_codes&#39;</span><span class="o">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">],</span>
<span class="err">   </span><span class="s1">&#39;return_response&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="err">   </span><span class="s1">&#39;parse_json&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="err">   </span><span class="s1">&#39;username&#39;</span><span class="o">:</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span>
<span class="err">   </span><span class="s1">&#39;password&#39;</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiKey</span><span class="p">,</span>
<span class="err">   </span><span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">}</span>
<span class="err"> </span><span class="p">};</span>

<span class="err"> </span><span class="nx">bodyObj</span> <span class="o">=</span> <span class="p">{</span>
<span class="err">   </span><span class="s1">&#39;to&#39;</span><span class="o">:</span> <span class="nx">address</span><span class="p">,</span>
<span class="err">   </span><span class="s1">&#39;subject&#39;</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span>
<span class="err">   </span><span class="s1">&#39;from&#39;</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fromAddress</span>
<span class="err"> </span><span class="p">};</span>

<span class="err"> </span><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isHTML</span><span class="p">)</span> <span class="p">{</span><span class="err">              </span><span class="c1">// 2)  switch based on the content type we want to send</span>
<span class="err">   </span><span class="nx">bodyObj</span><span class="p">.</span><span class="nx">html</span> <span class="o">=</span> <span class="nx">body</span><span class="p">;</span>
<span class="err"> </span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="err">   </span><span class="nx">bodyObj</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">body</span><span class="p">;</span>
<span class="err"> </span><span class="p">}</span>

<span class="err"> </span><span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span><span class="err">       </span><span class="c1">// 3)  merge in the headers so we can provide id’s as headers in the emails</span>
<span class="err">   </span><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
<span class="err">     </span><span class="nx">bodyObj</span><span class="p">[</span><span class="s1">&#39;h:&#39;</span> <span class="o">+</span> <span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
<span class="err">   </span><span class="p">}</span>
<span class="err"> </span><span class="p">}</span>

<span class="err"> </span><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">testMode</span><span class="p">)</span> <span class="p">{</span><span class="err">            </span><span class="c1">// 4) enable sandbox testing</span>
<span class="err">   </span><span class="nx">bodyObj</span><span class="p">[</span><span class="s1">&#39;o:testmode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="err"> </span><span class="p">}</span>

<span class="err"> </span><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="p">{</span><span class="err">                </span><span class="c1">// 5)  set some tags to automatically pivot analytics for visibility. (we view reporting in the Mailgun control panel but data is also available via API or webhook)</span>
<span class="err">   </span><span class="nx">bodyObj</span><span class="p">[</span><span class="s1">&#39;o:tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tags</span><span class="p">;</span>
<span class="err"> </span><span class="p">}</span>

<span class="err"> </span><span class="nx">body</span> <span class="o">=</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">bodyObj</span><span class="p">);</span>

<span class="err"> </span><span class="nx">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">httpOptions</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span><span class="err">   </span>
<span class="p">};</span>
</pre></div>